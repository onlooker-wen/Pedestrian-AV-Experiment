<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡Œäºº-è½¦è¾†äº¤äº’å†³ç­–å®éªŒ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background-color: #000;
            color: #fff;
            font-family: "Microsoft YaHei", Arial, sans-serif;
            overflow: hidden;
        }
        #container {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        #display {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        img, video {
            width: 100vw;
            height: 100vh;
            object-fit: cover;
        }
        .instruction {
            font-size: 32px;
            line-height: 2;
            text-align: center;
            padding: 40px;
        }
        .practice-instruction {
            font-size: 36px;
            line-height: 2.5;
            text-align: center;
        }
        .practice-question {
            font-size: 40px;
            margin-bottom: 60px;
            font-weight: bold;
        }
        .feedback {
            font-size: 48px;
            font-weight: bold;
        }
        .correct {
            color: #00ff00;
        }
        .incorrect {
            color: #ff0000;
        }
        .fixation {
            font-size: 80px;
            font-weight: bold;
            color: #fff;
        }
        .response-cue {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            border: 5px solid #FFD700;
            border-radius: 50%;
            animation: pulse 0.8s ease-in-out infinite;
            box-shadow: 0 0 20px #FFD700;
        }
        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.15); opacity: 0.8; }
        }
        
        #inputScreen {
            background-color: #000;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        #inputScreen h1 {
            font-size: 48px;
            margin-bottom: 40px;
            letter-spacing: 3px;
        }
        #inputScreen input {
            font-size: 32px;
            padding: 15px 30px;
            background-color: #333;
            color: #fff;
            border: 2px solid #666;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 30px;
            width: 400px;
        }
        #inputScreen button {
            font-size: 28px;
            padding: 15px 50px;
            background-color: #4CAF50;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
        }
        #inputScreen button:hover {
            background-color: #45a049;
        }
        
        #monitorPanel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.95);
            color: #fff;
            padding: 20px;
            overflow-y: auto;
            transition: right 0.3s;
            z-index: 1000;
            border-left: 2px solid #4CAF50;
        }
        #monitorPanel.show {
            right: 0;
        }
        #monitorToggle {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 10px 15px;
            background-color: rgba(76, 175, 80, 0.8);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1001;
            font-size: 14px;
        }
        #monitorPanel h3 {
            color: #4CAF50;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .monitor-item {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            font-size: 12px;
        }
        .monitor-item strong {
            color: #FFD700;
        }
        .hidden {
            display: none !important;
        }
        
        #fullscreenPrompt {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.9);
            padding: 40px;
            border-radius: 10px;
            text-align: center;
            z-index: 2000;
        }
        #fullscreenPrompt button {
            margin-top: 20px;
            font-size: 24px;
            padding: 15px 40px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
    <script>
        // è®¡ç®—ç´ ææ ¹è·¯å¾„ï¼ˆå…¼å®¹ GitHub Pagesï¼‰
        (function () {
            var root = location.pathname.replace(/[^/]*$/, '');
            window.MATERIAL_PATH = root + 'material/';
            console.log('[å®éªŒ] MATERIAL_PATH =', window.MATERIAL_PATH);
        })();
    </script>
</head>
<body>
    <div id="fullscreenPrompt" class="hidden">
        <h2 style="font-size: 32px; margin-bottom: 20px;">å®éªŒéœ€è¦å…¨å±æ¨¡å¼</h2>
        <p style="font-size: 20px;">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è¿›å…¥å…¨å±</p>
        <button onclick="enterFullscreen()">è¿›å…¥å…¨å±</button>
    </div>

    <button id="monitorToggle" class="hidden" onclick="toggleMonitor()">ğŸ“Š æ•°æ®ç›‘æ§</button>
    <div id="monitorPanel">
        <h3>å®æ—¶æ•°æ®ç›‘æ§</h3>
        <div id="monitorContent"></div>
    </div>

    <div id="inputScreen">
        <h1>æ¬¢è¿å‚ä¸å®éªŒ</h1>
        <input type="text" id="participantId" placeholder="è¯·è¾“å…¥è¢«è¯•ç¼–å·" maxlength="20">
        <button onclick="startExperimentWithId()">å¼€å§‹å®éªŒ</button>
    </div>

    <div id="container" class="hidden">
        <div id="display"></div>
    </div>

    <script>
        // å®éªŒé…ç½®
        const config = {
            introImages: ['intro_01.png', 'intro_02.png', 'intro_03.png'],
            beginImage: 'begin.png',
            breakImage: 'break.png',
            endImage: 'end.png',
            exampleVideos: ['example1.mp4', 'example2.mp4'],
            decisionVideos: [
                'Crossing_v1.mp4', 'Crossing_v2.mp4',
                'Following_v1.mp4', 'Following_v2.mp4',
                'parking_v2.mp4', 'parking.mp4',
                'Starting_v2.mp4', 'starting.mp4'
            ],
            fixationDuration: 3000,
            videoBeforeCue: 6000,
            responseTimeout: 20000
        };

        // ç»ƒä¹ è¯•æ¬¡
        const practiceTrials = [
            { question: 'è¯·æŒ‰ä¸‹èƒ½è¡¨ç¤ºã€è‡ªå·±å…ˆé€šè¿‡ã€‘çš„é”®', correctKey: 'j' },
            { question: 'è¯·æŒ‰ä¸‹èƒ½è¡¨ç¤ºã€è®©è½¦å…ˆé€šè¿‡ã€‘çš„é”®', correctKey: 'f' }
        ];

        // å®éªŒæ•°æ®
        let experimentData = {
            participantId: '',
            startTime: '',
            practiceData: [],
            blockData: []
        };

        let currentPhase = 'intro';
        let currentIndex = 0;
        let currentBlock = 0;
        let currentTrial = 0;
        let blockOrder = [];
        let trialStartTime = 0;
        let awaitingResponse = false;
        let currentVideo = '';
        let currentExample = '';
        let currentVideos = [];
        let videoElement = null;
        let responseTimeout = null;
        let responseCueTimeout = null;
        let monitorVisible = false;

        // å…¨å±ç›¸å…³
        function enterFullscreen() {
            const elem = document.documentElement;
            
            if (elem.requestFullscreen) {
                elem.requestFullscreen({ navigationUI: "hide" });
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen();
            } else if (elem.mozRequestFullScreen) {
                elem.mozRequestFullScreen();
            } else if (elem.msRequestFullscreen) {
                elem.msRequestFullscreen();
            }
            
            document.getElementById('fullscreenPrompt').classList.add('hidden');
            
            setTimeout(() => {
                window.scrollTo(0, 1);
            }, 100);
        }

        function checkFullscreen() {
            if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.msFullscreenElement) {
                document.getElementById('fullscreenPrompt').classList.remove('hidden');
            }
        }

        document.addEventListener('fullscreenchange', checkFullscreen);
        document.addEventListener('webkitfullscreenchange', checkFullscreen);
        document.addEventListener('msfullscreenchange', checkFullscreen);

        // å¼€å§‹å®éªŒï¼ˆè¾“å…¥è¢«è¯•ç¼–å·åï¼‰
        function startExperimentWithId() {
            const participantId = document.getElementById('participantId').value.trim();
            
            if (!participantId) {
                alert('è¯·è¾“å…¥è¢«è¯•ç¼–å·ï¼');
                return;
            }
            
            experimentData.participantId = participantId;
            experimentData.startTime = new Date().toISOString();
            
            updateMonitor('å®éªŒå¼€å§‹', `è¢«è¯•ç¼–å·: ${participantId}`);
            
            // åªæœ‰è¢«è¯•ç¼–å·ä¸º621æ—¶æ‰æ˜¾ç¤ºç›‘æ§æŒ‰é’®
            if (participantId === '621') {
                document.getElementById('monitorToggle').classList.remove('hidden');
            } else {
                document.getElementById('monitorToggle').classList.add('hidden');
            }
            
            document.getElementById('inputScreen').classList.add('hidden');
            document.getElementById('container').classList.remove('hidden');
            
            enterFullscreen();
            
            setTimeout(() => {
                startExperiment();
            }, 500);
        }

        // åˆ‡æ¢ç›‘æ§é¢æ¿
        function toggleMonitor() {
            monitorVisible = !monitorVisible;
            const panel = document.getElementById('monitorPanel');
            if (monitorVisible) {
                panel.classList.add('show');
            } else {
                panel.classList.remove('show');
            }
        }

        // æ›´æ–°ç›‘æ§é¢æ¿
        function updateMonitor(title, content) {
            const monitorContent = document.getElementById('monitorContent');
            const timestamp = new Date().toLocaleTimeString();
            const item = document.createElement('div');
            item.className = 'monitor-item';
            item.innerHTML = `<strong>[${timestamp}] ${title}</strong><br>${content}`;
            monitorContent.insertBefore(item, monitorContent.firstChild);
            
            while (monitorContent.children.length > 20) {
                monitorContent.removeChild(monitorContent.lastChild);
            }
        }

        // éšæœºåŒ–Blocké¡ºåº
        function randomizeBlockOrder() {
            blockOrder = shuffle([0, 1]);
        }

        // æ‰“ä¹±æ•°ç»„
        function shuffle(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        // æ˜¾ç¤ºæ³¨è§†ç‚¹
        function showFixation() {
            const display = document.getElementById('display');
            display.innerHTML = `<div class="fixation">+</div>`;
        }

        // æ˜¾ç¤ºå›¾ç‰‡
        function showImage(imageName) {
            const display = document.getElementById('display');
            display.innerHTML = `<img src="${MATERIAL_PATH}${imageName}" alt="${imageName}">`;
        }

        // æ˜¾ç¤ºè§†é¢‘
        function showVideo(videoName) {
            const display = document.getElementById('display');
            display.innerHTML = `
                <video id="experimentVideo" autoplay>
                    <source src="${MATERIAL_PATH}${videoName}" type="video/mp4">
                </video>
            `;
            
            videoElement = document.getElementById('experimentVideo');
            videoElement.play().catch(e => console.error('è§†é¢‘æ’­æ”¾å¤±è´¥:', e));
            
            return videoElement;
        }

        // æ˜¾ç¤ºååº”æç¤ºåœˆ
        function showResponseCue() {
            const cue = document.createElement('div');
            cue.className = 'response-cue';
            cue.id = 'responseCue';
            document.getElementById('display').appendChild(cue);
        }

        // ç§»é™¤ååº”æç¤ºåœˆ
        function removeResponseCue() {
            const cue = document.getElementById('responseCue');
            if (cue) cue.remove();
        }

        // æ˜¾ç¤ºæ–‡æœ¬æŒ‡å¯¼
        function showInstruction(text) {
            const display = document.getElementById('display');
            display.innerHTML = `<div class="instruction">${text}</div>`;
        }

        // æ˜¾ç¤ºç»ƒä¹ æŒ‡å¯¼
        function showPracticeInstruction(text) {
            const display = document.getElementById('display');
            display.innerHTML = `<div class="practice-instruction"><div class="practice-question">${text}</div>(æŒ‰é”™å°†é‡æ–°ç»ƒä¹ )</div>`;
        }

        // æ˜¾ç¤ºåé¦ˆ
        function showFeedback(correct) {
            const display = document.getElementById('display');
            const feedbackClass = correct ? 'correct' : 'incorrect';
            const feedbackText = correct ? 'âœ“' : 'âœ—';
            display.innerHTML = `<div class="feedback ${feedbackClass}">${feedbackText}</div>`;
        }

        // æ¸…é™¤æ‰€æœ‰è®¡æ—¶å™¨
        function clearAllTimers() {
            if (responseTimeout) {
                clearTimeout(responseTimeout);
                responseTimeout = null;
            }
            if (responseCueTimeout) {
                clearTimeout(responseCueTimeout);
                responseCueTimeout = null;
            }
        }

        // é”®ç›˜äº‹ä»¶å¤„ç†
        document.addEventListener('keydown', handleKeyPress);

        function handleKeyPress(e) {
            const key = e.key.toLowerCase();
            
            if (currentPhase === 'intro') {
                if (key === ' ') {
                    e.preventDefault();
                    nextIntro();
                }
            } else if (currentPhase === 'practice') {
                if (awaitingResponse && (key === 'f' || key === 'j')) {
                    e.preventDefault();
                    handlePracticeResponse(key);
                }
            } else if (currentPhase === 'decision') {
                if (awaitingResponse && (key === 'f' || key === 'j')) {
                    e.preventDefault();
                    handleDecisionResponse(key);
                }
            } else if (currentPhase === 'waitForSpace') {
                if (key === ' ') {
                    e.preventDefault();
                    continueFromWait();
                }
            } else if (currentPhase === 'instructionWait') {
                if (key === ' ') {
                    e.preventDefault();
                    nextDecisionTrial();
                }
            }
        }

        // å¼€å§‹å®éªŒ
        function startExperiment() {
            randomizeBlockOrder();
            currentPhase = 'intro';
            currentIndex = 0;
            showImage(config.introImages[0]);
            updateMonitor('é˜¶æ®µ', 'æŒ‡å¯¼è¯­é˜¶æ®µ');
        }

        // ä¸‹ä¸€å¼ æŒ‡å¯¼è¯­
        function nextIntro() {
            currentIndex++;
            if (currentIndex < config.introImages.length) {
                showImage(config.introImages[currentIndex]);
            } else {
                startPractice();
            }
        }

        // å¼€å§‹ç»ƒä¹ 
        function startPractice() {
            currentPhase = 'practice';
            currentTrial = 0;
            updateMonitor('é˜¶æ®µ', 'ç»ƒä¹ é˜¶æ®µ');
            nextPracticeTrial();
        }

        // ä¸‹ä¸€ä¸ªç»ƒä¹ è¯•æ¬¡
        function nextPracticeTrial() {
            if (currentTrial < practiceTrials.length) {
                const trial = practiceTrials[currentTrial];
                showPracticeInstruction(trial.question);
                awaitingResponse = true;
                trialStartTime = Date.now();
            } else {
                showPracticeComplete();
            }
        }

        // å¤„ç†ç»ƒä¹ ååº”
        function handlePracticeResponse(key) {
            if (!awaitingResponse) return;
            
            awaitingResponse = false;
            const rt = Date.now() - trialStartTime;
            const trial = practiceTrials[currentTrial];
            const correct = (key === trial.correctKey);
            
            experimentData.practiceData.push({
                trial: currentTrial + 1,
                question: trial.question,
                correctKey: trial.correctKey,
                response: key,
                rt: rt,
                correct: correct
            });

            const msg = `è¯•æ¬¡${currentTrial + 1}: ${correct ? 'æ­£ç¡®' : 'é”™è¯¯'} (${key}é”®)`;
            updateMonitor('ç»ƒä¹ ååº”', msg);

            showFeedback(correct);
            
            setTimeout(() => {
                if (correct) {
                    currentTrial++;
                    nextPracticeTrial();
                } else {
                    currentTrial = 0;
                    experimentData.practiceData.push({
                        event: 'practice_restart',
                        timestamp: new Date().toISOString()
                    });
                    updateMonitor('ç»ƒä¹ ', 'ç­”é”™ï¼Œé‡æ–°å¼€å§‹ç»ƒä¹ ');
                    nextPracticeTrial();
                }
            }, 1000);
        }

        // æ˜¾ç¤ºç»ƒä¹ å®Œæˆ
        function showPracticeComplete() {
            showImage(config.beginImage);
            currentPhase = 'waitForSpace';
            currentIndex = 0;
            updateMonitor('é˜¶æ®µ', 'ç»ƒä¹ å®Œæˆï¼Œå‡†å¤‡è¿›å…¥æ­£å¼å®éªŒ');
        }

        // ä»ç­‰å¾…çŠ¶æ€ç»§ç»­
        function continueFromWait() {
            if (currentIndex === 0) {
                startBlock(0);
            } else if (currentIndex === 1) {
                startBlock(1);
            } else if (currentIndex === 2) {
                saveDataToExcel();
            }
        }

        // å¼€å§‹Block
        function startBlock(blockNum) {
            currentBlock = blockNum;
            currentPhase = 'learning';
            currentTrial = 0;
            
            const exampleIndex = blockOrder[blockNum];
            currentExample = config.exampleVideos[exampleIndex];
            
            experimentData.blockData.push({
                block: blockNum + 1,
                exampleVideo: currentExample,
                trials: []
            });

            const msg = `Block ${blockNum + 1}, ç¤ºä¾‹è§†é¢‘: ${currentExample}`;
            updateMonitor('Blockå¼€å§‹', msg);

            showInstruction('è¯·å…ˆè§‚çœ‹ä¸‹é¢çš„è§†é¢‘<br>æ— éœ€åšå‡ºååº”');
            
            setTimeout(() => {
                const video = showVideo(currentExample);
                video.onended = () => {
                    setTimeout(() => {
                        startDecisionPhase();
                    }, 500);
                };
            }, 3000);
        }

        // å¼€å§‹å†³ç­–é˜¶æ®µ
        function startDecisionPhase() {
            currentPhase = 'instructionWait';
            currentTrial = 0;
            currentVideos = shuffle([...config.decisionVideos]);
            
            experimentData.blockData[currentBlock].videoOrder = currentVideos;
            
            const msg = `Block ${currentBlock + 1} å†³ç­–é˜¶æ®µå¼€å§‹`;
            updateMonitor('å†³ç­–é˜¶æ®µ', msg);
            
            showInstruction('æ¥ä¸‹æ¥è¯·è§‚çœ‹è§†é¢‘å¹¶åšå‡ºé€‰æ‹©<br><br>å½“å‡ºç°é‡‘é»„è‰²åœ†åœˆæç¤ºæ—¶ï¼Œè¯·ç«‹å³åšå‡ºååº”<br><br>Fé”® = è®©è½¦å…ˆé€šè¿‡ï¼ˆè®©è¡Œï¼‰<br>Jé”® = è‡ªå·±å…ˆé€šè¿‡ï¼ˆä¸è®©è¡Œï¼‰<br><br><br>ç†è§£åè¯·æŒ‰"ç©ºæ ¼é”®"å¼€å§‹');
        }

        // ä¸‹ä¸€ä¸ªå†³ç­–è¯•æ¬¡
        function nextDecisionTrial() {
            currentPhase = 'decision';
            
            if (currentTrial < currentVideos.length) {
                showFixation();
                
                setTimeout(() => {
                    currentVideo = currentVideos[currentTrial];
                    const msg = `Block ${currentBlock + 1}, Trial ${currentTrial + 1}: ${currentVideo}`;
                    updateMonitor('Trialå¼€å§‹', msg);
                    
                    const video = showVideo(currentVideo);
                    
                    responseCueTimeout = setTimeout(() => {
                        showResponseCue();
                        awaitingResponse = true;
                        trialStartTime = Date.now();
                        
                        const cueMsg = `Trial ${currentTrial + 1}: é‡‘åœˆå‡ºç°ï¼Œç­‰å¾…è¢«è¯•ååº”`;
                        updateMonitor('ç­‰å¾…ååº”', cueMsg);
                        
                        responseTimeout = setTimeout(() => {
                            if (awaitingResponse) {
                                handleDecisionResponse(null, true);
                            }
                        }, config.responseTimeout);
                    }, config.videoBeforeCue);
                    
                    video.onended = () => {};
                }, config.fixationDuration);
                
            } else {
                if (currentBlock === 0) {
                    showBreak();
                } else {
                    showEnd();
                }
            }
        }

        // å¤„ç†å†³ç­–ååº”
        function handleDecisionResponse(key, timeout = false) {
            if (!awaitingResponse && !timeout) return;
            
            awaitingResponse = false;
            clearAllTimers();
            removeResponseCue();
            
            const rt = timeout ? null : (Date.now() - trialStartTime);
            
            const trialData = {
                block: currentBlock + 1,
                trial: currentTrial + 1,
                video: currentVideo,
                scenario: getScenarioName(currentVideo),
                response: timeout ? 'timeout' : (key === 'f' ? 'yield' : 'not_yield'),
                responseKey: timeout ? 'none' : key,
                responseLabel: timeout ? 'è¶…æ—¶æ— ååº”' : (key === 'f' ? 'è®©è¡Œ' : 'ä¸è®©è¡Œ'),
                rt: rt,
                timestamp: new Date().toISOString()
            };
            
            experimentData.blockData[currentBlock].trials.push(trialData);
            
            const msg = `Trial ${currentTrial + 1}: ${trialData.responseLabel}, RT=${rt ? rt.toFixed(0) + 'ms' : 'è¶…æ—¶'}`;
            updateMonitor('ååº”è®°å½•', msg);
            
            currentTrial++;
            
            setTimeout(() => {
                nextDecisionTrial();
            }, 200);
        }

        // ä»è§†é¢‘æ–‡ä»¶åæå–åœºæ™¯åç§°
        function getScenarioName(videoName) {
            if (videoName.includes('Crossing')) return 'Crossing';
            if (videoName.includes('Following')) return 'Following';
            if (videoName.includes('parking')) return 'Parking';
            if (videoName.includes('Starting')) return 'Starting';
            return 'Unknown';
        }

        // æ˜¾ç¤ºä¼‘æ¯
        function showBreak() {
            showImage(config.breakImage);
            currentPhase = 'waitForSpace';
            currentIndex = 1;
            updateMonitor('é˜¶æ®µ', 'Block 1 å®Œæˆï¼Œä¼‘æ¯ä¸­');
        }

        // æ˜¾ç¤ºç»“æŸ
        function showEnd() {
            experimentData.endTime = new Date().toISOString();
            showImage(config.endImage);
            currentPhase = 'waitForSpace';
            currentIndex = 2;
            updateMonitor('é˜¶æ®µ', 'å®éªŒå®Œæˆ');
        }

        // ä¿å­˜æ•°æ®ä¸ºExcel
        function saveDataToExcel() {
            const excelData = [];
            
            experimentData.blockData.forEach(block => {
                block.trials.forEach(trial => {
                    excelData.push({
                        'è¢«è¯•ç¼–å·': experimentData.participantId,
                        'Block': trial.block,
                        'Blockç¤ºä¾‹è§†é¢‘': block.exampleVideo,
                        'Trial': trial.trial,
                        'Trialè§†é¢‘': trial.video,
                        'åœºæ™¯ç±»å‹': trial.scenario,
                        'è¡Œä¸ºé€‰æ‹©': trial.responseLabel,
                        'æŒ‰é”®': trial.responseKey,
                        'ååº”æ—¶é—´(ms)': trial.rt,
                        'æ—¶é—´æˆ³': trial.timestamp
                    });
                });
            });
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(excelData);
            
            XLSX.utils.book_append_sheet(wb, ws, "å®éªŒæ•°æ®");
            
            const filename = `${experimentData.participantId}.xlsx`;
            XLSX.writeFile(wb, filename);
            
            updateMonitor('æ•°æ®ä¿å­˜', `æ–‡ä»¶å·²ä¸‹è½½: ${filename}`);
            
            showInstruction('æ•°æ®å·²ä¸‹è½½ï¼<br>æ–‡ä»¶åï¼š' + filename + '<br><br>æ„Ÿè°¢å‚ä¸ï¼');
        }
    </script>
</body>
</html>